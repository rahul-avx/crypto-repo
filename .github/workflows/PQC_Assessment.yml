name: Run PQC_Assessment_Tool

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  security-events: write
  contents: read

jobs:
  run-pqc-assessment:
    runs-on: [self-hosted]

    steps:
      # -------------------------------
      # Checkout repository
      # -------------------------------
      - name: Checkout Target Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # Full history

      # -------------------------------
      # Validate the checkout folder
      # -------------------------------
      - name: Validate Input Folder
        shell: powershell
        run: |
          Write-Host "Checking current directory contents..."
          Get-ChildItem -Force

          if (-not (Test-Path "./")) {
            Write-Error "Checkout folder missing!"
            exit 1
          }

      # -------------------------------
      # Prepare output folder
      # -------------------------------
      - name: Prepare Output Folder
        shell: powershell
        run: |
          Write-Host "Creating output folder..."
          New-Item -ItemType Directory -Force -Path "output-folder" | Out-Null
          Write-Host "Output-folder created."

      # -------------------------------
      # Run PQC Assessment Tool
      # -------------------------------
      - name: Run PQC_Assessment Executable
        shell: powershell
        run: |
          Write-Host "Running PQC Tool..."
          & "C:\Users\appviewx\Desktop\code-scan-agent.exe" `
              --input-folder "." `
              --output-folder ".\output-folder" `
              --key "C:\code-scan\secret.key" `
              --config "C:\code-scan\config.ini"

      # -------------------------------
      # Upload CBOM Artifact
      # -------------------------------
      - name: Upload CBOM output as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: CBOM-output
          path: output-folder

      # -------------------------------
      # Find SARIF File Dynamically
      # -------------------------------
      - name: Find SARIF file
        id: find_sarif
        shell: powershell
        run: |
          $sarif = Get-ChildItem -Path "output-folder" -Filter *.sarif -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $sarif) {
            Write-Error "No SARIF file found in output-folder"
            exit 1
          }
          Write-Host "Found SARIF file: $($sarif.FullName)"
          echo "sarif_path=$($sarif.FullName)" >> $env:GITHUB_OUTPUT

      # -------------------------------
      # Upload SARIF to Security Dashboard
      # -------------------------------
      - name: Upload SARIF Results
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ steps.find_sarif.outputs.sarif_path }}
